<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Space Invaders</title>

    <link rel="stylesheet" href="./style/main.css">
    <script src="./js/helpers.js"></script>
</head>
<body>
   <script>
       let gameScreen, input, frames, sprite_frame, level_frame;
       let alien_sprites, tank_sprite, city_sprite;
       let aliens, direction, tank, bullets, cities;

       function main() {
            gameScreen = new GameScreen(502, 600);
            input = new InputHandler();

            let sprite_sheet = new Image();
            sprite_sheet.src = "./assets/invaders.png";

            sprite_sheet.addEventListener("load", function () {
                alien_sprites = [
                    [ new Sprite(this,  0, 0, 22, 16),  new Sprite(this,  0, 16, 22, 16) ],
                    [ new Sprite(this, 22, 0, 16, 16),  new Sprite(this, 22, 16, 16, 16) ],
                    [ new Sprite(this, 38, 0, 24, 16),  new Sprite(this, 38, 16, 24, 16) ],
                ];
                tank_sprite = new Sprite(this, 62, 0, 22, 16);
                city_sprite = new Sprite(this, 84, 8, 36, 24);

                init();
                run();
            })
            
       }

       function init() {
            frames = 0;
            sprite_frame = 0;
            level_frame = 20;
            aliens = [];
            direction = 1;

            tank = {
                sprite: tank_sprite,
                x: (gameScreen.width - tank_sprite.width) / 2,
                y: gameScreen.height - (30 + tank_sprite.height) / 2,
            }

            let enemy_row = [ 1, 0, 0, 2, 2 ];
            for (let i = 0; i < enemy_row.length; i++) {
                for (let j = 0; j < 10; j++) {
                    const enemy = enemy_row[i];
                
                    aliens.push({
                        sprites: alien_sprites[enemy],
                        width: alien_sprites[enemy][0].width,
                        height: alien_sprites[enemy][0].height,
                        x: 30 + (j * 30) + [0, 4, 0][enemy],
                        y: 30 + (i * 30),
                    })
                }
            }
       }

       function run() {
            let loop = function() {
                update();
                render();
                window.requestAnimationFrame(loop, gameScreen.canvas);
            }
            window.requestAnimationFrame(loop, gameScreen.canvas);
       }

       function update() {

        if (input.isDown(37)) { // LEFT
            tank.x -= 4;
        }

        if (input.isDown(39)) { // RIGHT
            tank.x += 4;
        }

        tank.x = Math.max(Math.min(tank.x, gameScreen.width - (30 + tank.sprite.width)), 30);

           frames++;
           if (!(frames % level_frame)) {
               sprite_frame = (sprite_frame + 1) % 2;

               let _max = 0, _min = gameScreen.width;

               for (let i = 0; i < aliens.length; i++) {
                   let alien = aliens[i];
                    alien.x += 30 * direction;

                    _max = Math.max(_max, alien.x + alien.width);
                    _min = Math.min(_min, alien.x);
               }

               if (_max > gameScreen.width || _min < 30) {
                    direction *= -1;

                    for (let i = 0; i < aliens.length; i++) {
                        let alien = aliens[i];
                        alien.x += 30 * direction;
                        alien.y += 30;
                    }
               }
           }
       }

       function render() {
           gameScreen.clear();

           for(let i = 0; i < aliens.length; i++) {
               let alien = aliens[i];
               gameScreen.drawSprite(alien.sprites[sprite_frame], alien.x, alien.y);
           } 

           gameScreen.drawSprite(tank.sprite, tank.x, tank.y)
       }

       main();
   </script>   
</body>
</html>